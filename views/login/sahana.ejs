<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
      import { app, auth } from "/firebase-config.js";
      import {
        signInWithEmailAndPassword,
        RecaptchaVerifier,
        signInWithPhoneNumber,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      // ===========================
      // 1. EMAIL LOGIN LOGIC
      // ===========================
      async function loginWithEmail() {
        let email = document.getElementById("email").value; // Changed to input
        let password = document.getElementById("password").value;

        signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => handleSuccess(userCredential.user))
          .catch((error) => showError(error.message));
      }

      // ===========================
      // 2. PHONE LOGIN LOGIC
      // ===========================
      function setupRecaptcha() {
        if (!window.recaptchaVerifier) {
          window.recaptchaVerifier = new RecaptchaVerifier(
            auth,
            "recaptcha-container",
            {
              size: "invisible",
              callback: () => console.log("Captcha Solved"),
            }
          );
        }
      }

      async function sendOTP() {
        setupRecaptcha();
        const phoneNumber = document.getElementById("phone").value;
        const appVerifier = window.recaptchaVerifier;

        signInWithPhoneNumber(auth, phoneNumber, appVerifier)
          .then((confirmationResult) => {
            window.confirmationResult = confirmationResult;
            // Show OTP Input
            document.getElementById("phone-step-1").classList.add("hidden");
            document.getElementById("phone-step-2").classList.remove("hidden");
            showMessage("OTP Sent!", "text-green-400");
          })
          .catch((error) => showError(error.message));
      }

      async function verifyOTP() {
        const code = document.getElementById("otp").value;
        window.confirmationResult
          .confirm(code)
          .then((result) => handleSuccess(result.user))
          .catch((error) => showError("Invalid OTP"));
      }

      // ===========================
      // 3. SHARED HELPERS
      // ===========================
      async function handleSuccess(user) {
        const token = await user.getIdToken();
        await fetch("/saveToken", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token }),
        });
        window.location.href = "/dashboard";
      }

      function showError(msg) {
        const el = document.getElementById("msg");
        el.innerText = msg;
        el.classList.remove("hidden", "text-green-400");
        el.classList.add("text-red-400");
      }

      function showMessage(msg, colorClass) {
        const el = document.getElementById("msg");
        el.innerText = msg;
        el.classList.remove("hidden", "text-red-400");
        el.classList.add(colorClass);
      }

      // Toggle Tabs
      function switchTab(tab) {
        document.getElementById("msg").classList.add("hidden");
        if (tab === "email") {
          document.getElementById("email-form").classList.remove("hidden");
          document.getElementById("phone-form").classList.add("hidden");
          document.getElementById("tab-email").classList.add("bg-indigo-600");
          document
            .getElementById("tab-phone")
            .classList.remove("bg-indigo-600");
        } else {
          document.getElementById("email-form").classList.add("hidden");
          document.getElementById("phone-form").classList.remove("hidden");
          document.getElementById("tab-phone").classList.add("bg-indigo-600");
          document
            .getElementById("tab-email")
            .classList.remove("bg-indigo-600");
        }
      }

      // Expose to Window
      window.loginWithEmail = loginWithEmail;
      window.sendOTP = sendOTP;
      window.verifyOTP = verifyOTP;
      window.switchTab = switchTab;
    </script>
  </head>

  <body
    class="flex justify-center items-center h-screen bg-[#0d1333] text-white"
  >
    <div class="bg-white/10 p-8 rounded-xl w-[350px]">
      <h2 class="text-2xl mb-6 font-bold text-center">Login</h2>

      <div class="flex mb-6 bg-white/10 rounded overflow-hidden">
        <button
          id="tab-email"
          onclick="switchTab('email')"
          class="flex-1 p-2 bg-indigo-600 hover:bg-indigo-500 transition"
        >
          Email
        </button>
        <button
          id="tab-phone"
          onclick="switchTab('phone')"
          class="flex-1 p-2 hover:bg-indigo-500 transition"
        >
          Phone
        </button>
      </div>

      <div id="email-form">
        <input
          id="email"
          type="email"
          value="sahana_cloud@advigroups.com"
          placeholder="Email"
          class="w-full p-3 bg-white/20 rounded mb-3 placeholder-gray-400"
        />
        <input
          id="password"
          type="password"
          placeholder="Password"
          class="w-full p-3 bg-white/20 rounded mb-4 placeholder-gray-400"
        />
        <button
          onclick="loginWithEmail()"
          class="w-full bg-indigo-600 hover:bg-indigo-700 p-3 rounded font-bold"
        >
          Sign In
        </button>
      </div>

      <div id="phone-form" class="hidden">
        <div id="recaptcha-container"></div>

        <div id="phone-step-1">
          <input
            id="phone"
            type="text"
            placeholder="+91 98765 43210"
            class="w-full p-3 bg-white/20 rounded mb-4 placeholder-gray-400"
          />
          <button
            onclick="sendOTP()"
            class="w-full bg-indigo-600 hover:bg-indigo-700 p-3 rounded font-bold"
          >
            Get OTP
          </button>
        </div>

        <div id="phone-step-2" class="hidden">
          <input
            id="otp"
            type="text"
            placeholder="Enter 6-digit OTP"
            class="w-full p-3 bg-white/20 rounded mb-4 placeholder-gray-400 text-center tracking-widest"
          />
          <button
            onclick="verifyOTP()"
            class="w-full bg-green-600 hover:bg-green-700 p-3 rounded font-bold"
          >
            Verify & Login
          </button>
        </div>
      </div>

      <p id="msg" class="hidden mt-4 text-center text-sm"></p>
    </div>
  </body>
</html>
